// Operating System Check for OS specific features
if(navigator.userAgent.toLowerCase().includes("linux")){
    document.body.setAttribute("linux", true);
} else if(navigator.userAgent.toLowerCase().includes("win")) {
    document.body.setAttribute("windows", true);
};

// Components

var components = {
    dialog: {
        _: document.querySelector("#dialog"),
        title: document.querySelector("#dialog #dialog-title"),
        input: document.querySelector("#dialog #dialog-input"),
        ok: document.querySelector("#dialog #dialog-ok"),
        cancel: document.querySelector("#dialog #dialog-cancel"),
        resolve: null
    },
	warning: {
		_: document.querySelector("#warning"),
		description: document.querySelector("#warning #description")
	},
	input: {
		url: document.querySelector("#input #url"),
		name: document.querySelector("#input #name"),
		incognito: document.querySelector("#input #incognito")
	},
	controls: {
		autofill: document.querySelector("#controls #autofill"),
		copy_url: document.querySelector("#controls #copy-url"),
		new_bookmark: document.querySelector("#controls #new-bookmark"),
		open_ssb: document.querySelector("#controls #open-ssb"),
		add_desktop_entry_windows: document.querySelector("#controls #add-desktop-entry-windows"),
		add_desktop_entry_linux: document.querySelector("#controls #add-desktop-entry-linux")
	}
};

// Localization

["uiURL", "uiName", "uiIncognito", "uiAutofillFromTab", "uiCopyURL", "uiNewBookmark", "uiOpenSSB", "uiOpenGuide", "uiExtOnGitHub", "uiCreateDesktopFile"].forEach(name => {
	document.querySelectorAll(`.local-${name}`).forEach((element) => {
		let class_list = Array.from(element.classList);
		if(class_list.includes("local-inner")){
			element.innerText = browser.i18n.getMessage(name);
		}
		if(class_list.includes("local-title")){
			element.title = browser.i18n.getMessage(name);
		}
	})
})

// Functions

async function active_tab_info() {
	let [tab] = await browser.tabs.query(queryOptions = { active: true, lastFocusedWindow: true });
	return ({
		name: tab.title,
		url: tab.url,
		id: tab.id
	});
};

function create_ssb_url() {
	let the_url = location.origin + 
					"/ssb.html?url=" + encodeURIComponent(components.input.url.value) +
					"&name=" + encodeURIComponent(components.input.name.value) + 
					"&incognito=" + encodeURIComponent(components.input.incognito.checked);
	the_url = the_url.replaceAll("%","=-=");
	return the_url;
};

function show_warning(uiKey) {
	let warning_id = (window.last_warning_id ?? 0) + 1;
	window.last_warning_id = warning_id;
	components.warning.description.innerText = browser.i18n.getMessage(uiKey);
	components.warning._.setAttribute("open", true);
	setTimeout((the_id = warning_id) => {
		if(window.last_warning_id == the_id){
			if(components.warning._.hasAttribute("open")){
				components.warning._.removeAttribute("open");
			};
		};
	}, 3000);
};

function sanitize_input(input, only_letters=false) { // Sanitizer function the input that comes from the user
    if(only_letters) {
        return sanitize_input(input.replace(/\W/g,""));
    } else {
        return input.replace(/[\`\"\'\,\.\:\;\$\[\]\\\(\)\{\}\#\<\>\&\|\!\/\-\_\=\n\r\t\?\@]*/g, "");
    };
};

function download_file(url, name){ // Download helper to download desktop files
    let link = document.createElement("a");
    link.target = "_blank";
    link.download = name;
    link.href = url;
    document.body.append(link);
    link.click();
    link.remove();
};

function modern_prompt(title, pretext = "", placeholder = ""){
    components.dialog._.setAttribute("open", true);
    return new Promise((resolve) => {
        components.dialog.title.innerText = title;
        components.dialog.input.value = pretext;
        components.dialog.input.placeholder = placeholder;
        components.dialog.resolve = (content) => {
            if(components.dialog._.hasAttribute("open")){
                components.dialog._.removeAttribute("open");
            };
            resolve(content);
        };
    });
};

// Event Listeners

components.dialog.ok.addEventListener("click", () => {
    components.dialog.resolve(
        components.dialog.input.value
    );
});

components.dialog.cancel.addEventListener("click", () => {
    components.dialog.resolve(false);
});

components.controls.autofill.addEventListener("click", async function() {
	let tab_info = await active_tab_info();
	components.input.url.value = tab_info.url;
	components.input.name.value = tab_info.name;
});

components.controls.copy_url.addEventListener("click", function() {
	if(components.input.url.value == "") return show_warning("warningEmptyURL");
	navigator.clipboard.writeText(create_ssb_url());
});

components.controls.new_bookmark.addEventListener("click", async function() {
	if(components.input.url.value == "") return show_warning("warningEmptyURL");
	if(components.input.name.value == "") return show_warning("warningEmptyName");

	if(await browser.permissions.request({permissions: ["bookmarks"]})){
		browser.bookmarks.create({
			title: components.input.name.value,
			url: create_ssb_url()
		});
	};
});

components.controls.open_ssb.addEventListener("click", async function() {
	if(components.input.url.value == ""){
		let active_tab = await active_tab_info();
		browser.windows.create({
			tabId: active_tab.id,
			type: "popup"
		});
	} else {
		browser.windows.create({
			url: components.input.url.value,
			type: "popup"
		});
	}
});

components.controls.add_desktop_entry_windows.addEventListener("click", async function() {
	if(components.input.url.value == "") return show_warning("warningEmptyURL");
	if(components.input.name.value == "") return show_warning("warningEmptyName");

    let name = sanitize_input(components.input.name.value);
    let ssb_url = create_ssb_url();
    let previous_application = localStorage.previous_firefox_application ?? "firefox";
    let application = await modern_prompt(browser.i18n.getMessage("browserCommandName"), previous_application, "");
    if(application === false) return;
    application = sanitize_input(application);
    localStorage.previous_firefox_application = application;
    let profile = await modern_prompt(browser.i18n.getMessage("profile"), "", browser.i18n.getMessage("useDefaultProfile"));
    if(profile === false) return;
    profile = sanitize_input(profile, true);
    if(profile != "") profile = "-P " + profile;

    // Windows LNKs (shortcuts) is too complex files to encode/decode easily
    // So i created a shortcut template to create SSB links
    let lnk_start_of_file =  [0x4C, 0x00, 0x00, 0x00, 0x01, 0x14, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x46, 0xEF, 0x40, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x0F, 0x63, 0xBA, 0xFF,
        0x6B, 0xD5, 0xD6, 0x01, 0xD7, 0xD7, 0x96, 0x76, 0xD6, 0x95, 0xDA, 0x01, 0x0F, 0x63, 0xBA, 0xFF, 0x6B, 0xD5,
        0xD6, 0x01, 0x00, 0x40, 0x04, 0x00, 0x0C, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x35, 0x01, 0x14, 0x00, 0x1F, 0x50, 0xE0, 0x4F, 0xD0, 0x20,
        0xEA, 0x3A, 0x69, 0x10, 0xA2, 0xD8, 0x08, 0x00, 0x2B, 0x30, 0x30, 0x9D, 0x19, 0x00, 0x2F, 0x43, 0x3A, 0x5C,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x56, 0x00, 0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x97, 0x58, 0x51, 0xBA, 0x10, 0x00, 0x57, 0x69, 0x6E,
        0x64, 0x6F, 0x77, 0x73, 0x00, 0x40, 0x00, 0x09, 0x00, 0x04, 0x00, 0xEF, 0xBE, 0x2F, 0x4D, 0x2E, 0x31, 0x97,
        0x58, 0x51, 0xBA, 0x2E, 0x00, 0x00, 0x00, 0x25, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x94, 0x38, 0x93, 0x00, 0x57, 0x00, 0x69,
        0x00, 0x6E, 0x00, 0x64, 0x00, 0x6F, 0x00, 0x77, 0x00, 0x73, 0x00, 0x00, 0x00, 0x16, 0x00, 0x5A, 0x00, 0x31,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x97, 0x58, 0xF2, 0xBA, 0x10, 0x00, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x33,
        0x32, 0x00, 0x00, 0x42, 0x00, 0x09, 0x00, 0x04, 0x00, 0xEF, 0xBE, 0x2F, 0x4D, 0x2E, 0x31, 0x97, 0x58, 0xF2,
        0xBA, 0x2E, 0x00, 0x00, 0x00, 0x20, 0x05, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9A, 0x10, 0xC5, 0x00, 0x53, 0x00, 0x79, 0x00, 0x73,
        0x00, 0x74, 0x00, 0x65, 0x00, 0x6D, 0x00, 0x33, 0x00, 0x32, 0x00, 0x00, 0x00, 0x18, 0x00, 0x56, 0x00, 0x32,
        0x00, 0x00, 0x40, 0x04, 0x00, 0x92, 0x51, 0xEF, 0x93, 0x20, 0x00, 0x63, 0x6D, 0x64, 0x2E, 0x65, 0x78, 0x65,
        0x00, 0x40, 0x00, 0x09, 0x00, 0x04, 0x00, 0xEF, 0xBE, 0x92, 0x51, 0xEF, 0x93, 0x97, 0x58, 0x4D, 0xB5, 0x2E,
        0x00, 0x00, 0x00, 0x82, 0x28, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF1, 0x09, 0x09, 0x01, 0x63, 0x00, 0x6D, 0x00, 0x64, 0x00, 0x2E,
        0x00, 0x65, 0x00, 0x78, 0x00, 0x65, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x4A, 0x00, 0x00, 0x00, 0x1C,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 0x2D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x49, 0x00, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0xEF, 0x24, 0x50, 0x74, 0x10,
        0x00, 0x00, 0x00, 0x00, 0x43, 0x3A, 0x5C, 0x57, 0x69, 0x6E, 0x64, 0x6F, 0x77, 0x73, 0x5C, 0x53, 0x79, 0x73,
        0x74, 0x65, 0x6D, 0x33, 0x32, 0x5C, 0x63, 0x6D, 0x64, 0x2E, 0x65, 0x78, 0x65, 0x00, 0x00, 0x10, 0x00, 0x46,
        0x00, 0x69, 0x00, 0x72, 0x00, 0x65, 0x00, 0x53, 0x00, 0x53, 0x00, 0x42, 0x00, 0x20, 0x00, 0x53, 0x00, 0x68,
        0x00, 0x6F, 0x00, 0x72, 0x00, 0x74, 0x00, 0x63, 0x00, 0x75, 0x00, 0x74, 0x00, 0x21, 0x00, 0x2E, 0x00, 0x2E,
        0x00, 0x5C, 0x00, 0x2E, 0x00, 0x2E, 0x00, 0x5C, 0x00, 0x2E, 0x00, 0x2E, 0x00, 0x5C, 0x00, 0x57, 0x00, 0x69,
        0x00, 0x6E, 0x00, 0x64, 0x00, 0x6F, 0x00, 0x77, 0x00, 0x73, 0x00, 0x5C, 0x00, 0x53, 0x00, 0x79, 0x00, 0x73,
        0x00, 0x74, 0x00, 0x65, 0x00, 0x6D, 0x00, 0x33, 0x00, 0x32, 0x00, 0x5C, 0x00, 0x63, 0x00, 0x6D, 0x00, 0x64,
        0x00, 0x2E, 0x00, 0x65, 0x00, 0x78, 0x00, 0x65, 0x00, 0x73, 0x02, 0x2F, 0x00, 0x63, 0x00, 0x20, 0x00, 0x73,
        0x00, 0x74, 0x00, 0x61, 0x00, 0x72, 0x00, 0x74, 0x00, 0x20, 0x00];
    let lnk_end_of_file = [0x17, 0x00, 0x43, 0x00, 0x3A, 0x00, 0x5C, 0x00, 0x57, 0x00, 0x69, 0x00, 0x6E, 0x00,
        0x64, 0x00, 0x6F, 0x00, 0x77, 0x00, 0x73, 0x00, 0x5C, 0x00, 0x65, 0x00, 0x78, 0x00, 0x70, 0x00, 0x6C, 0x00,
        0x6F, 0x00, 0x72, 0x00, 0x65, 0x00, 0x72, 0x00, 0x2E, 0x00, 0x65, 0x00, 0x78, 0x00, 0x65, 0x00, 0x14, 0x03,
        0x00, 0x00, 0x07, 0x00, 0x00, 0xA0, 0x25, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D, 0x52, 0x6F, 0x6F, 0x74, 0x25,
        0x5C, 0x65, 0x78, 0x70, 0x6C, 0x6F, 0x72, 0x65, 0x72, 0x2E, 0x65, 0x78, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x25, 0x00, 0x53, 0x00,
        0x79, 0x00, 0x73, 0x00, 0x74, 0x00, 0x65, 0x00, 0x6D, 0x00, 0x52, 0x00, 0x6F, 0x00, 0x6F, 0x00, 0x74, 0x00,
        0x25, 0x00, 0x5C, 0x00, 0x65, 0x00, 0x78, 0x00, 0x70, 0x00, 0x6C, 0x00, 0x6F, 0x00, 0x72, 0x00, 0x65, 0x00,
        0x72, 0x00, 0x2E, 0x00, 0x65, 0x00, 0x78, 0x00, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x05, 0x00,
        0x00, 0xA0, 0x25, 0x00, 0x00, 0x00, 0xDD, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x00, 0x00, 0x0B, 0x00, 0x00, 0xA0,
        0x77, 0x4E, 0xC1, 0x1A, 0xE7, 0x02, 0x5D, 0x4E, 0xB7, 0x44, 0x2E, 0xB1, 0xAE, 0x51, 0x98, 0xB7, 0xDD, 0x00,
        0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0xA0, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x64, 0x65, 0x73, 0x6B, 0x74, 0x6F, 0x70, 0x2D, 0x73, 0x32, 0x67, 0x76, 0x61, 0x68, 0x71, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0xA4, 0xA1, 0xCF,
        0xC0, 0x01, 0xEF, 0x11, 0x96, 0x12, 0x52, 0x54, 0x00, 0x73, 0x03, 0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0xA4, 0xA1, 0xCF, 0xC0, 0x01, 0xEF, 0x11,
        0x96, 0x12, 0x52, 0x54, 0x00, 0x73, 0x03, 0x46, 0x00, 0x00, 0x00, 0x00];

    // Actually 1236 however, file format requires "\x00" after every char
    // Also it can be changed however LNK table should be re-edited
    let allowed_app_command_len = 618;

    let app_command = `${application} ${profile} -new-window "${ssb_url}"`;
    if(app_command.length>=allowed_app_command_len) return show_warning("exceedCommandSize");

    let lnk_mid_of_file = (app_command.padEnd(allowed_app_command_len, "\x00").split("").join("\x00")+"\x00").split("").map(x=>x.charCodeAt(0));

    var lnk_content_blob = new Blob([new Uint8Array([...lnk_start_of_file, ...lnk_mid_of_file, ...lnk_end_of_file])], {
        type: "application/octet-stream"
    });

    let lnk_download_uri = URL.createObjectURL(lnk_content_blob);
    download_file(lnk_download_uri, name + ".lnk");
    URL.revokeObjectURL(lnk_download_uri);
});

components.controls.add_desktop_entry_linux.addEventListener("click", async function() {
	if(components.input.url.value == "") return show_warning("warningEmptyURL");
	if(components.input.name.value == "") return show_warning("warningEmptyName");

    let name = sanitize_input(components.input.name.value);
    let ssb_url = create_ssb_url();
    let previous_application = localStorage.previous_firefox_application ?? "firefox";
    let application = await modern_prompt(browser.i18n.getMessage("browserCommandName"), previous_application, "");
    if(application === false) return;
    application = sanitize_input(application);
    localStorage.previous_firefox_application = application;
    let profile = await modern_prompt(browser.i18n.getMessage("profile"), "", browser.i18n.getMessage("useDefaultProfile"));
    if(profile === false) return;
    profile = sanitize_input(profile, true);
    if(profile != "") profile = "-P " + profile;
	let desktop_entry = `[Desktop Entry]
Encoding=UTF-8
Version=1.0
Type=Application
Terminal=false
Exec="${application}" ${profile} -new-window "${ssb_url}"
Name=${name}
Icon=applications-internet`;
    download_file("data:application/octet-stream," + encodeURIComponent(desktop_entry), name + ".desktop");
});

// Check Permissions

(async () => {
	let can_access_incognito = await browser.extension.isAllowedIncognitoAccess();
	if(!can_access_incognito) {
		components.input.incognito.style.cursor = "not-allowed";
		components.input.incognito.checked = false;
		components.input.incognito.disabled = true;
		components.input.incognito.title = browser.i18n.getMessage("uiRequiredIncognito");
	};
})();
